<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>
      SMART App Authorization Guide
    </title>

    <!-- Bootstrap core CSS -->
    <link href="/smart-on-fhir/assets/css/bootstrap-cosmo.css" rel="stylesheet">

    <!-- Documentation extras -->
    <link href="/smart-on-fhir/assets/css/smart-on-fhir-docs.css" rel="stylesheet">
	
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">

  </head>
  <body data-spy="scroll" data-target=".page-navbar">

    <!-- Docs master nav -->
    <header class="navbar navbar-static-top bs-docs-nav" id="top" role="banner">
    <div class="container">
      <div class="navbar-header">
        <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/smart-on-fhir/" class="navbar-brand">SMART on FHIR (AU)</a>
      </div>

      <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">

      <ul class="nav navbar-nav">
        <li class="dropdown">
        <a href="/smart-on-fhir/sandbox" class="dropdown-toggle" data-toggle="dropdown">Sandbox<b class="caret"></b></a>
        <ul class="dropdown-menu">
          <li><a href="/smart-on-fhir/sandbox">Overview</a></li>
          <li><a href="/smart-on-fhir/sandbox/account">Account Setup</a></li>
          <li><a href="/smart-on-fhir/sandbox/register">Register Your App</a></li>
          <li><a href="/smart-on-fhir/tutorials/testing">Test Your App</a></li>
          <li><a href="/smart-on-fhir/sandbox/install">Build Your Own Sandbox</a></li>
        </ul>
        </li>
        <li class="dropdown">
        <a href="/smart-on-fhir/sandbox" class="dropdown-toggle" data-toggle="dropdown">Client libraries<b class="caret"></b></a>
        <ul class="dropdown-menu">
          <li><a href="/smart-on-fhir/clients/javascript">JavaScript</a></li>
          <li><a href="/smart-on-fhir/clients/python">Python</a></li>
          <li><a href="/smart-on-fhir/Swift-SMART/">iOS</a></li>
          <li><a href="/smart-on-fhir/clients/others">Other Frameworks</a></li>
        </ul>
        </li>
        <li class="dropdown">
        <a href="/smart-on-fhir/authorization" class="dropdown-toggle" data-toggle="dropdown">Authorization<b class="caret"></b></a>
        <ul class="dropdown-menu">
          <li><a href="/smart-on-fhir/authorization">SMART App Authorization Guide</a></li>
          <li><a href="/smart-on-fhir/authorization/scopes-and-launch-context">Scopes and launch context</a></li>
          <li><a href="/smart-on-fhir/authorization/best-practices">Best practices for EHRs</a></li>
          <li><a href="/smart-on-fhir/authorization/backend-services">Backend services (draft)</a></li>
        </ul>
        </li>
        <li class="dropdown">
			<a href="/smart-on-fhir/profiles" class="dropdown-toggle" data-toggle="dropdown">Data<b class="caret"></b></a>
			<ul class="dropdown-menu">
				<li><a href="/smart-on-fhir/profiles">Overview</a></li>
				<li style="padding-left:10px"><a href="/smart-on-fhir/profiles">Patient</a></li>
				<li style="padding-left:20px"><a href="/smart-on-fhir/profiles/profile-ihi">IHI</a></li>
				<li style="padding-left:20px"><a href="/smart-on-fhir/profiles/profile-medicare">Medicare Number</a></li>
				<li style="padding-left:20px"><a href="/smart-on-fhir/profiles/profile-dvanumber">DVA Number</a></li>
				<li style="padding-left:20px"><a href="/smart-on-fhir/profiles/extension-indigenous-status">Indigenous Status</a></li>
				<li><a href="/smart-on-fhir/profiles/coding">Coding</a></li>
			</ul>
        </li>
        <li class="dropdown">
        <a href="/smart-on-fhir/tutorials" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
        <ul class="dropdown-menu">
           <li><a href="/smart-on-fhir/tutorials">Overview</a></li>
           <li><a href="/smart-on-fhir/tutorials/javascript">Building a JavaScript app</a></li>
           <li><a href="/smart-on-fhir/tutorials/rest">Building a REST app</a></li>
           <li><a href="/smart-on-fhir/tutorials/testing">Testing your app from localhost</a></li>
           <li><a href="/smart-on-fhir/tutorials/authorization">Simple Authorization App</a></li>
           <li><a href="/smart-on-fhir/tutorials/server-quick-start">Building a server: quick-start guide</a></li>
        </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://groups.google.com/forum/#!forum/smart-on-fhir">Google Group</a></li>
        <li><a href="https://github.com/smart-on-fhir">GitHub</a></li>
      </ul>
      </nav>
    </div>
    </header>


    <!-- Docs page layout -->
    <div id="master">
      <div class="container bs-docs-container">

        <div class="row">
          <div class="col-md-9 page-content" role="main">
            <h1>SMART App Authorization Guide</h1>

<p>SMART on FHIR provides reliable, secure authorization for a variety of app
architectures through the use of the OAuth 2.0 standard.  This Authorization
Guide supports the <a href="http://argonautwiki.hl7.org/images/4/4c/Argonaut_UseCasesV1.pdf">four uses cases</a> 
defined for Phase 1 of the <a href="http://argonautwiki.hl7.org/index.php?title=Main_Page">Argonaut
Project</a>.  </p>

<h2>Profile audience and scope</h2>

<p>This profile is intended to be used by developers of apps that need to 
access FHIR resources by requesting access tokens from OAuth 2.0 compliant 
authorization servers.</p>

<p>OAuth 2.0 authorization servers are configured to mediate access based on
a set of rules configured to enforce institutional policy, which may 
include requesting end-user authorization.  This profile 
does not dictate the institutional policies that are implemented in the 
authorization server.</p>

<p>The profile defines a method through which an app requests 
authorization to access a FHIR resource, and then uses that authorization 
to retrieve the resource.  Other HIPAA-mandated security mechanisms, 
such as end-user authentication, session time-out, security auditing, 
and accounting of disclosures, are outside the scope of this profile.</p>

<h2>Support for &quot;public&quot; and &quot;confidential&quot; apps</h2>

<p>Within this profile we differentiate between two types of 
apps based upon whether the execution environment within which the app runs 
enables the app to protect secrets.   Pure client-side apps 
(for example, HTML5/JS browser-based apps, iOS mobile
apps, or Windows desktop apps) can provide adequate security -- but they can&#39;t
&quot;keep a secret&quot; in the OAuth2 sense. That is to say, any &quot;secret&quot; key, code, or
string that&#39;s embedded in the app can potentially be extracted by an end-user
or attacker. So security for these apps can&#39;t depend on secrets embedded at
install-time. Security assurance comes from being hosted within a trusted 
server environment.</p>

<h4>Use the <span class="label label-primary">confidential app</span>  profile</h4>

<p>when all of the following apply:</p>

<ul>
<li>App runs on a trusted server</li>
<li>App has server-side business logic (e.g. using PHP, Python, Ruby, .NET, etc.)</li>
<li>App is <em>able to protect</em> a <code>client_secret</code></li>
</ul>

<h4>Use the <span class="label label-primary">public app</span> profile</h4>

<p>when all of the following apply:</p>

<ul>
<li>App runs on an end-user&#39;s device (e.g. HTML5/JS in-browser; native iOS, Windows, or Android)</li>
<li>App is <em>unable to protect</em> a <code>client_secret</code></li>
</ul>

<h2>Registering a SMART App with an EHR</h2>

<p>Before a SMART app can run against an EHR, the app must be registered with that
EHR&#39;s authorization service.  SMART does not specify a standards-based registration process, but we
encourage EHR implementers to consider the <a href="https://tools.ietf.org/html/draft-ietf-oauth-dyn-reg">OAuth 2.0 Dynamic Client
Registration Protocol</a>
for an out-of-the-box solution.</p>

<p>No matter how an app registers with an EHR&#39;s authorization service, at registration time <strong>every SMART app must</strong>:</p>

<ul>
<li>Register one or more fixed, fully-specified launch URL with the EHR&#39;s authorization server</li>
<li>Register one or more, fixed, fully-specified <code>redirect_uri</code>s with the EHR&#39;s authorization server</li>
</ul>

<h2>SMART authorization &amp; FHIR access: overview</h2>

<p>An app (confidential or public) can launch from within an existing EHR session,
which is known as an EHR launch.  Alternatively, it can launch as a standalone
app.</p>

<p>In an <span class="label label-primary">EHR launch</span>, an opaque handle to
the EHR context is passed along to the app as part of the launch URL.  The app
later will include this context handle as a scope parameter when it requests
authorization to access resources.  Note that the complete URLs of all apps
approved for use by users of this EHR will have been registered with the EHR
authorization server.</p>

<p>Alternatively, in a <span class="label label-primary">standalone launch</span>,
when the app launches from outside an EHR session, the app can request context
from the EHR authorization server during the authorization process described
below.</p>

<p>Once the app is launched, it requests authorization to access a FHIR resource
by redirecting its authorization request to the EHR’s authorization server.
Based on pre-defined rules and possibly end-user authorization, the EHR
authorization server either grants the request by returning an
authorization code to the app’s redirect URL, or denies the request.
The app then exchanges the authorization code for an access token, which
the app presents to the EHR’s resource server to obtain the FHIR resource.
If a refresh token is returned along with the access token, the app may
use this to request a new access token, with the same scope, once
the access token expires.</p>

<h2>SMART &quot;launch sequence&quot;</h2>

<p>The two alternative launch sequences are described below.</p>

<h3>EHR launch sequence</h3>

<p><img class="sequence-diagram-raw"  src="http://www.websequencediagrams.com/cgi-bin/cdraw?lz=RUhSIFNlc3Npb24gLT4-IEFwcDogUmVkaXJlY3QgdG8gaHR0cHM6Ly97YXBwIGxhdW5jaF91cml9P1xuAAgGPTEyMyZcbmlzcz0AIwlmaGlyIGJhc2UgdXJsfQpBcHAgLT4gRUhSIEZISVIgU2VydmVyOiBHRVQAVgoAJg4vbWV0YWRhdGEKACcPIC0AgR4HW0NvbmZvcm1hbmNlIHN0YXRlbWVudCBpbmNsdWRpbmcgT0F1dGggMi4wIGVuZHBvaW50IFVSTHNdAIEIBwCBCgZBdXRoegCBCAkAgWQVZWhyIGF1dGhvcml6AIFLBj9cbnNjb3BlPQCCCgYmXG4AewU9YWJjJgCCCA9hdWQ9AIIADyZcbi4uLgo&s=default"/></p>

<p>In SMART&#39;s <span class="label label-primary">EHR launch</span> flow (shown above), 
a user has established an EHR session, and then decides to launch an app. This 
could be a single-patient app (which runs in the context of a patient record), or 
a user-level app (like an appointment manager or a population dashboard). The EHR
initiates a &quot;launch sequence&quot; by opening a new browser instance (or <code>iframe</code>) 
pointing to the app&#39;s registered launch URL and passing some context.</p>

<p>The following parameters are included:</p>

<table class="table">
  <thead>
    <th colspan="3">Parameters</th>
  </thead>
  <tbody>
    <tr>
      <td><code>iss</code></td>
      <td><span class="label label-success">required</span></td>
      <td>

Identifies the EHR's FHIR endpoint, which the app can use to obtain
additional details about the EHR, including its authorization URL.

      </td>
    </tr>
    <tr>
      <td><code>launch</code></td>
      <td><span class="label label-success">required</span></td>
      <td>

      Opaque identifier for this specific launch, and any EHR context associated
with it. This parameter must be communicated back to the EHR  at authorization
time by passing along a <code>launch=123</code> parameter (see below).

      </td>
    </tr>
  </tbody>
</table>

<h4><em>For example</em></h4>

<p>A launch might cause the browser to redirect to:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Location: https://app/launch?iss=https%3A%2F%2Fehr%2Ffhir&amp;launch=xyz123
</code></pre></div>
<p>On receiving the launch notification, the app would query the issuer&#39;s
<code>/metadata</code> endpoint:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">GET https://ehr/fhir/metadata
Accept: application/json
</code></pre></div>
<p>The metadata response contains (among other details) the EHR&#39;s 
<a href="/smart-on-fhir/authorization/conformance-statement">
conformance statement</a> identifying the OAuth <code>authorize</code> and <code>token</code>
endpoint URLs for use in requesting authorization to access FHIR 
resources. </p>

<p>Later, when the app prepares a list of access scopes to request from
the EHR authorization server, it will bind to the existing EHR context by
including the launch notification in the scope.</p>

<h3>Standalone launch sequence</h3>

<p><img class="sequence-diagram-raw"  src="http://www.websequencediagrams.com/cgi-bin/cdraw?lz=QXBwIC0-IEVIUiBGSElSIFNlcnZlcjogR0VUIGh0dHBzOi8ve2ZoaXIgYmFzZSB1cmx9L21ldGFkYXRhCgAnDyAtPiBBcHA6IFtDb25mb3JtYW5jZSBzdGF0ZW1lbnQgaW5jbHVkaW5nIE9BdXRoIDIuMCBlbmRwb2ludCBVUkxzXQoAgQkGAIEKBkF1dGh6AIEICVJlZGlyZWN0IHRvAIEPCmVociBhdXRob3JpegCBFwY_XG5zY29wZT1sYXVuY2gmXG4AewU9YWJjJlxuYXVkPQCBPw8mXG4uLi4KCg&s=default"/></p>

<p>Alternatively, in SMART&#39;s <span class="label label-primary">standalone
launch</span> flow (shown above), a user selects an app from outside the EHR, 
for example by tapping an app icon on a mobile phone home screen. This app 
will launch from its registered URL without a launch id.   </p>

<p>In order to obtain launch context and request authorization to access FHIR 
resources, the app discovers the EHR authorization server&#39;s OAuth
<code>authorize</code> and <code>token</code> endpoint URLs by querying the FHIR endpoint
for the <a
href="/smart-on-fhir/authorization/conformance-statement"> 
EHR&#39;s conformance statement</a>.  </p>

<p>The app then can declare its launch context requirements
by adding specific scopes to the request it sends to the EHR&#39;s authorization
server.  The <code>authorize</code> endpoint 
will acquire the context the app needs and make it available.</p>

<h4><em>For example:</em></h4>

<p>If the app needs patient context, the EHR&#39;s authorization server 
may provide the end-user with a
patient selection widget.  For full details, see <a href="/smart-on-fhir/authorization/scopes-and-launch-context">SMART launch context parameters</a>.</p>

<ul>
<li>  launch/patient - to indicate that the app needs to know a patient ID</li>
<li>  launch/encounter - to indicate the app needs an encounter</li>
</ul>

<p><br><br></p>

<h2>SMART authorization and resource retrieval</h2>

<h4>First, a word about app protection...</h4>

<p>The app is responsible for protecting itself from potential misbehaving or
malicious values passed to its redirect URL (e.g., values injected with
executable code, such as SQL) and for protecting authorization codes, access
tokens, and refresh tokens from unauthorized access and use.  The app
developer must be aware of potential threats, such as malicious apps running
on the same platform, counterfeit authorization servers, and counterfeit
resource servers, and implement countermeasures to help protect both the app
itself and any sensitive information it may hold. For background, see the
<a href="https://tools.ietf.org/html/rfc6819">OAuth 2.0 Threat Model and Security
Considerations</a>.</p>

<ul>
<li><p>Apps MUST assure that sensitive information (authentication secrets,
authorization codes, tokens) is transmitted ONLY to authenticated servers,
over TLS-secured channels.</p></li>
<li><p>Apps MUST generate an unpredictable <code>state</code> parameter for each user
session.  An app MUST validate the <code>state</code> value for any request sent to its
redirect URL; include <code>state</code> with all authorization requests; and validate
the <code>state</code> value included in access tokens it receives.</p></li>
<li><p>An app should NEVER treat any inputs it receives as executable code.</p></li>
<li><p>An app MUST NOT forward values passed back to its redirect URL to any
other arbitrary or user-provided URL (a practice known as an “open
redirector”).</p></li>
<li><p>An app should NEVER store bearer tokens in cookies that are transmitted
in the clear.</p></li>
<li><p>Apps should persist tokens and other sensitive data in app-specific
storage locations only, not in system-wide-discoverable locations.</p></li>
</ul>

<h4><em>SMART authorization sequence</em></h4>

<p><img class="sequence-diagram-raw" src="http://www.websequencediagrams.com/cgi-bin/cdraw?lz=bm90ZSBsZWZ0IG9mIEFwcDogUmVxdWVzdCBhdXRob3JpemF0aW9uCkFwcCAtPj4gRUhSIEF1dGh6IFNlcnZlcjogUmVkaXJlY3QgaHR0cHM6Ly97ZWhyADUJZV91cmx9Py4uLgoAZgVvdmVyADITQQAnCCBBcHBcbihtYXkgaW5jbHVkZSBlbmQtdXNlAE4GZW50aWMAgQ4FXG5hbmQADw4AgSYJKQpOb3RlIABWGE9uIGFwcHJvdmFsCgCBQRAgLT4-AIIBBwCBSBBhcHAgcgCBZwdfdXJpfT9jb2RlPTEyMyYAgVcJAII-DUV4Y2hhbmdlIGNvZGUgZm9yIGFjY2VzcyB0b2tlbjtcbmlmIGNvbmZpZGVudGlhbCBjbGllbnQsAIFyCXNlY3JldApBcHAtPgCCaBJQT1NUAIJsCgBPBSB1cmx9XG5ncmFudF90eXBlPQCDOg1fY29kZSYAgSQSAIJ7GwCCagdlIGEAgxQFAIEcFgCCaQcAg0YXSXNzdWUgbmV3AIFyBiB3aXRoIGNvbnRleHQ6XG4ge1xuIgCCEwZfAIIUBSI6IgCBcwYtAIIjBS14eXoiLFxuImV4cGlyZXMtaW4iOjM2MDAsXG4icGF0aWVudCI6IjQ1NiIsXG4uLi5cbn0Ag0MUAIVZBVsAgnYMIHJlc3BvbnNlXQ&s=default&h=NA3OIkJNCqFraI5a"></p>

<p><a id="step-1"></a></p>

<h4>1. App asks for authorization</h4>

<p>At launch time, the app constructs a request for authorization by adding the
following parameters to the query component of the EHR’s &quot;authorize&quot; endpoint
URL using the &quot;application/x-www-form-urlencoded&quot; format:</p>

<table class="table">
  <thead>
    <th colspan="3">Parameters</th>
  </thead>
  <tbody>
    <tr>
      <td><code>response_type</code></td>
      <td><span class="label label-success">required</span></td>
      <td>Fixed value: <code>code</code>. </td>
    </tr>
    <tr>
      <td><code>client_id</code></td>
      <td><span class="label label-success">required</span></td>
      <td>The client's identifier. </td>
    </tr>
    <tr>
      <td><code>redirect_uri</code></td>
      <td><span class="label label-success">required</span></td>
      <td>Must match one of the client's pre-registered redirect URIs.</td>
    </tr>
    <tr>
      <td><code>launch</code></td>
      <td><span class="label label-info">optional</span></td>
      <td>When using the <span class="label label-primary">EHR launch</span>flow, this must match the launch value received from the EHR.</td>
    </tr>
    <tr>
      <td><code>scope</code></td>
      <td><span class="label label-success">required</span></td>
      <td>

Must describe the access that the app needs, including clinical data scopes like
<code>patient/*.read</code>, <code>openid</code> and <code>profile</code> (if app 
needs authenticated patient identity) and either:

<ul>
<li> a <code>launch</code> value indicating that the app wants to receive already-established launch context details from the EHR </li>
<li> a set of launch context requirements in the form <code>launch/patient</code>, which asks the EHR to establish context on your behalf.</a>
</ul>

See <a href="/smart-on-fhir/authorization/scopes-and-launch-context">SMART on FHIR Access
Scopes</a> details.

      </td>
    </tr>
    <tr>
      <td><code>state</code></td>
      <td><span class="label label-success">required</span></td>
      <td>

An opaque value used by the client to maintain state between the request and
callback. The authorization server includes this value when redirecting the
user-agent back to the client. The parameter MUST be used for preventing
cross-site request forgery or session fixation attacks.

      </td>
    </tr>
     <tr>
      <td><code>aud</code></td>
      <td><span class="label label-success">required</span></td>
      <td>

URL of the EHR resource server from which the app wishes to retrieve FHIR data.
This parameter prevents leaking a genuine bearer token to a counterfeit
resource server. (Note: in the case of an <span class="label label-primary">EHR launch</span>
flow, this <code>aud</code> value is the same as the launch's <code>iss</code> value.)

      </td>
    </tr>
  </tbody>
</table>

<p>The app MUST use an unpredictable value for the state parameter
with at least 128 bits of entropy. The app MUST validate the value
of the state parameter upon return to the redirect URL and MUST ensure
that the state value is securely tied to the user’s current session
(e.g., by relating the state value to a session identifier issued
by the app). The app SHOULD limit the grants, scope, and period of
time requested to the minimum necessary.</p>

<p>If the app needs to authenticate the identity of the end-user, it should
include two OpenID Connect scopes:  <code>openid</code> and <code>profile</code>.   When these scopes
are requested, and the request is granted, the app will receive an id_token
along with the access token.  For full details, see <a href="./scopes-and-launch-context">SMART launch context
parameters</a>.</p>

<h4><em>For example</em></h4>

<p>An app that needs demographics and observations for a single
patient, and also wants information about the current logged-in user, the app  can request:</p>

<ul>
<li><code>patient/Patient.read</code></li>
<li><code>patient/Observation.read</code></li>
<li><code>openid profile</code></li>
</ul>

<p>If the app was launched from an EHR, the app adds a <code>launch</code> scope and a
<code>launch={launch id}</code> URL parameter, echoing the value it received from the EHR
to bind to the EHR context of this launch notification.</p>

<p><em>Apps using the <span class="label label-primary">standalone launch</span> flow
won&#39;t have a <code>launch</code> id at this point.  These apps can declare launch context
requirements by adding specific scopes to the authorization request: for
example, <code>launch/patient</code> to indicate that you need to know a patient ID, or
<code>launch/encounter</code> to indicate you need an encounter.  The EHR&#39;s &quot;authorize&quot;
endpoint will take care of acquiring the context you need (and then making it
available to you).  For example, if your app needs patient context, the EHR may
provide the end-user with a patient selection widget.  For full details, see <a
href="/smart-on-fhir/authorization/scopes-and-launch-context">SMART launch
context parameters</a>.</em></p>

<p>The app then redirects the browser to the EHR&#39;s <strong>authorization URL</strong> as
determined above:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Location: https://ehr/authorize?
            response_type=code&amp;
            client_id=app-client-id&amp;
            redirect_uri=https%3A%2F%2Fapp%2Fafter-auth&amp;
            launch=xyz123&amp;
            scope=launch+patient%2FObservation.read+patient%2FPatient.read+openid+profile&amp;
            state=98wrghuwuogerg97&amp;
            aud=https://ehr/fhir
</code></pre></div>
<p><br><br></p>

<p><a id="step-2"></a></p>

<h4>2. EHR evaluates authorization request, asking for end-user input</h4>

<p>The authorization decision is up to the EHR authorization server,
which may request authorization from the end-user. The EHR authorization
server will enforce access rules based on local policies and optionally direct
end-user input.  If an EHR launches the app for an authenticated user who has
explicitly requested the launch, asking for the end user&#39;s authorization is
optional; else the user&#39;s authorization SHOULD be requested.  The user
should be given information regarding the client requesting the access,
the request, the scope, and the time access is needed.</p>

<p>The EHR decides whether to grant or deny access.  This decision is
communicated to the app when the EHR authorization server returns an
authorization code.  Authorization codes are short-lived, usually expiring
within around one minute.  The code is sent when the EHR authorization server
redirects the browser to the app&#39;s <code>redirect_uri</code>, with the
following URL parameters:</p>

<table class="table">
  <thead>
    <th colspan="3">Parameters</th>
  </thead>
  <tbody>
    <tr>
      <td><code>code</code></td>
      <td><span class="label label-success">required</span></td>

      <td>

    The authorization code generated by the authorization server. The
authorization code *must* expire shortly after it is issued to mitigate the
risk of leaks.

      </td>
    </tr>
    <tr>
      <td><code>state</code></td>
      <td><span class="label label-success">required</span></td>
      <td>The exact value received from the client.</td>
    </tr>
  </tbody>
</table>

<h4><em>For example</em></h4>

<p>Based on the <code>client_id</code>, current EHR user, configured policy, and perhaps
direct user input, the EHR makes a decision to approve or deny access.  This
decision is communicated to the app by redirection to the app&#39;s registered
<code>redirect_uri</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Location: https://app/after-auth?
  code=123abc&amp;
  state=98wrghuwuogerg97
</code></pre></div>
<p><br><br></p>

<p><a id="step-3"></a></p>

<h4>3. App exchanges authorization code for access token</h4>

<p>After obtaining an authorization code, the app trades the code for an access
token via HTTP <code>POST</code> to the EHR authorization server&#39;s token endpoint URL,
using content-type <code>application/x-www-form-urlencoded</code>, as described in 
section 4.1.3 of RFC6749](<a href="https://tools.ietf.org/html/rfc6749#page-29">https://tools.ietf.org/html/rfc6749#page-29</a>). </p>

<p>For <span class="label label-primary">public apps</span>, authentication is not
possible (and thus not required), since the app cannot be trusted to protect a
secret.  For <span class="label label-primary">confidential apps</span>, an
<code>Authorization</code> header using HTTP Basic authentication is required, where the
username is the app&#39;s <code>client_id</code> and the password is the app&#39;s <code>client_secret</code>
(see <a href="./basic-auth-example">example</a>).</p>

<table class="table">
  <thead>
    <th colspan="3">Parameters</th>
  </thead>
  <tbody>
    <tr>
      <td><code>grant_type</code></td>
      <td><span class="label label-success">required</span></td>
      <td>Fixed value: <code>authorization_code</code></td>
    </tr>
    <tr>
      <td><code>code</code></td>
      <td><span class="label label-success">required</span></td>
      <td>Code that the app received from the authorization server</td>
    </tr>
    <tr>
      <td><code>redirect_uri</code></td>
      <td><span class="label label-success">required</span></td>
      <td>The same redirect_uri used in the initial authorization request</td>
    </tr>
    <tr>
      <td><code>client_id</code></td>
      <td><span class="label label-warning">conditional</span></td>
      <td>Required for <span class="label label-primary">public apps</span>. Omit for <span class="label label-primary">confidential apps</span>.</td>
    </tr>
  </tbody>
</table>

<p>The EHR authorization server SHALL return a JSON structure that includes an access token
or a message indicating that the authorization request has been denied. The JSON structure
includes the following parameters:</p>

<table class="table">
  <thead>
    <th colspan="3">Parameters</th>
  </thead>
  <tbody>
    <tr>
      <td><code>access_token</code></td>
      <td><span class="label label-success">required</span></td>
      <td>The access token issued by the authorization server</td>
    </tr>
    <tr>
      <td><code>token_type</code></td>
      <td><span class="label label-success">required</span></td>
      <td>Fixed value: <code>Bearer</code></td>
    </tr>
    <tr>
      <td><code>expires_in</code></td>
      <td><span class="label label-info">recommended</span></td>
      <td>Lifetime in seconds of the access token, after which the token SHALL NOT be accepted by the resource server</td>
    </tr>
    <tr>
      <td><code>scope</code></td>
      <td><span class="label label-success">required</span></td>
      <td>Scope of access authorized. Note that this can be different from the scopes requested by the app.</td>
    </tr>
     <tr>
      <td><code>state</code></td>
      <td><span class="label label-success">required</span></td>
      <td>The exact value received from the client in the authorization request</td>
    </tr>
    <tr>
      <td><code>id_token</code></td>
      <td><span class="label label-info">optional</span></td>
      <td>Authenticated patient identity and profile, if requested</td>
    </tr>
      <tr>
      <td><code>refresh_token</code></td>
      <td><span class="label label-info">optional</span></td>
      <td>Token that can be used to obtain a new access token, using the same or a subset of the original authorization grants</td>
    </tr>
  </tbody>
</table>

<p>In addition, if the app was launched from within a patient context, 
parameters to communicate the context values MAY BE included. For example, 
a parameter like <code>&quot;patient&quot;: &quot;123&quot;</code> would indicate the FHIR resource 
https://[fhir-base]/Patient/123. Other context parameters may also 
be available. For full details see <a href="http://docs.smarthealthit.org/authorization/scopes-and-launch-context/">SMART launch context parameters</a>. </p>

<p>The parameters are included in the entity-body of the HTTP response, as 
described in section 5.1 of <a href="https://tools.ietf.org/html/rfc6749">RFC6749</a>. </p>

<p>The access token is a string of characters as defined in 
<a href="https://tools.ietf.org/html/rfc6749">RFC6749</a> and 
<a href="http://tools.ietf.org/html/rfc6750">RFC6750</a>.  The token is essentially 
a private message that the authorization server 
passes to the FHIR Resource Server, telling the FHIR server that the 
&quot;message bearer&quot; has been authorized to access the specified resources.<br>
Defining the format and content of the access token is left up to the 
organization that issues the access token and holds the requested resource. </p>

<p>The authorization server&#39;s response MUST 
include the HTTP &quot;Cache-Control&quot; response header field with a value 
of &quot;no-store,&quot; as well as the &quot;Pragma&quot; response header field with a 
value of &quot;no-cache.&quot; </p>

<p>The EHR authorization server decides what <code>expires_in</code> value to assign to an
access token and whether to issue a refresh token, as defined in section 1.5
of <a href="https://tools.ietf.org/html/rfc6749#page-10">RFC6749</a>, along with the 
access token.  If the app receives a refresh token along with the access 
token, it can exchange this refresh token for a new access token when the 
current access token expires (see step 5 below).  A refresh token MUST 
BE bound to the same <code>client_id</code> and MUST contain the same, or a subset of, 
the set of claims authorized for the access token with which it is associated.  </p>

<p>Apps SHOULD store tokens in app-specific storage locations only, not in
system-wide-discoverable locations.  Access tokens SHOULD have a valid
lifetime no greater than one hour, and refresh tokens (if issued) SHOULD
have a valid lifetime no greater than twenty-four hours.  Confidential
clients may be issued longer-lived tokens than public clients.</p>

<p>A large range of threats to bearer tokens can be mitigated by digitally 
signing the token as specified in <a href="https://tools.ietf.org/html/rfc7515">RFC7515</a> 
or by using a Message Authentication Code (MAC) instead.  Alternatively, 
a bearer token can contain a reference to authorization information, 
rather than encoding the information directly into the token itself.<br>
To be effective, such references must be infeasible for an attacker to 
guess.  Using a reference may require an extra interaction between the 
resource server and the authorization server; the mechanics of such an 
interaction are not defined by this specification. </p>

<h4><em>For example</em></h4>

<p><a id="step-4"></a>
Given an authorization code, the app trades it for an access token via HTTP
<code>POST</code>.</p>

<h5>Request for</h5>
<div class="highlight"><pre><code class="language-text" data-lang="text">POST /token HTTP/1.1
Host: ehr
Authorization: Basic bXktYXBwOm15LWFwcC1zZWNyZXQtMTIz
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&amp;
code=123abc&amp;
redirect_uri=https%3A%2F%2Fapp%2Fafter-auth
</code></pre></div>
<h5>Response</h5>
<div class="highlight"><pre><code class="language-text" data-lang="text">{
  &quot;access_token&quot;: &quot;i8hweunweunweofiwweoijewiwe&quot;,
  &quot;token_type&quot;: &quot;bearer&quot;,
  &quot;expires_in&quot;: 3600,
  &quot;scope&quot;: &quot;patient/Observation.read patient/Patient.read&quot;,
  &quot;state&quot;: &quot;98wrghuwuogerg97&quot;,
  &quot;intent&quot;: &quot;client-ui-name&quot;,
  &quot;patient&quot;:  &quot;123&quot;,
  &quot;encounter&quot;: &quot;456&quot;
}
</code></pre></div>
<p>At this point, <strong>the authorization flow is complete</strong>. Follow steps below to work with
data and refresh access tokens, as shown in the following sequence diagram.</p>

<h4><em>SMART retrieval and refresh sequence</em></h4>

<p><img class="sequence-diagram-raw"
src="http://www.websequencediagrams.com/cgi-bin/cdraw?lz=bm90ZSBvdmVyIEFwcDogQWNjZXNzIHBhdGllbnQgZGF0YSAKQXBwLT5FSFIgRkhJUiBTZXJ2ZXI6IEdFVCBodHRwczovL3tmaGlyIGJhc2UgdXJsfS9QADoGLzEyMwoAWAoAMhFSZXR1cm4AUQZyZXNvdXJjZSB0byBhcHAKAGEPLT4AgRsFeyIAIAhUeXBlIjogIgBkByIsICJiaXJ0aERhdGUiOi4uLn0AbwsAgVAMdG9rZW4gZXhwaXJlcy4uLgAXEC4uLiBzbyByZXF1ZXN0IGEgbmV3AC8GAIF_CkF1dGh6AIIBCSBQT1MAggELAFsGdXJsfVxuZ3JhbnRfdHlwZT1yZWZyZXNoXwB7BSZcbgADDT1hYmMAghsSAFkOQXV0aGVudGljYXRlIGFwcFxuKGlmIGNvbmZpZGVudGlhbCBjbGllbnQpCk4ALBtJc3N1ZQCBSwpcbntcbiJhAINzBQCBFgYiOiAic2VjcmV0LQCCJwUteHl6IixcbiIAgi0HX2luIjogMzYwMCxcbiIAgUoNIjogIm5leHQtAIFmBy0xMjMiXG4uLi5cbn0KfQoAg1EFAIIxDACDUAdbAHoGAIMVB3Jlc3BvbnNlXQoKCgoKCgABBQo&s="></p>

<p><br><br></p>

<h4>4. App accesses clinical data via FHIR API</h4>

<p>With a valid access token, the app can access protected EHR data by issuing a
FHIR API call to the FHIR endpoint on the EHR&#39;s resource server. The request includes an
<code>Authorization</code> header that presents the <code>access_token</code> as a &quot;Bearer&quot; token:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Authorization: Bearer {{access_token}}
</code></pre></div>
<p>(Note that in a real request, <code>{{access_token}}</code>is replaced
with the actual token value.)</p>

<h4><em>For example</em></h4>

<p>With this response, the app knows which patient is in-context, and has an
OAuth2 bearer-type access token that can be used to fetch clinical data:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">GET https://ehr/fhir/Patient/123
Authorization: Bearer i8hweunweunweofiwweoijewiwe

{
  &quot;resourceType&quot;: &quot;Patient&quot;,
  &quot;birthTime&quot;: ...
}
</code></pre></div>
<p>The EHR&#39;s FHIR resource server validates the access token and ensures that it
has not expired and that its scope covers the requested FHIR resource.  The
resource server also validates that the <code>aud</code> parameter associated with the
authorization (see <a href="#step-1">above</a>) matches the resource server&#39;s own FHIR
endpoint.  The method used by the EHR to validate the access token is beyond
the scope of this specification but generally involves an interaction or
coordination between the EHR’s resource server and the authorization server.</p>

<p>On occasion, an app may receive a FHIR resource that contains a “reference” to
a resource hosted on a different resource server.  The app SHOULD NOT blindly
follow such references and send along its access_token, as the token may be
subject to potential theft.   The app SHOULD either ignore the reference, or
initiate a new request for access to that resource.
<br><br></p>

<p><a id="step-5"></a></p>

<h4>5. (Later...) App uses a refresh token to obtain a new access token</h4>

<p>The app can use the <code>expires_in</code> field from the authorization response (see <a
href="#step-3">step 3</a>) to determine when its access token will expire.
After an access token expires, it may be possible to request an updated token
without user intervention, if the app asked for a refresh token via the
<code>offline_access</code> scope (see <a
href="/smart-on-fhir/authorization/scopes-and-launch-context">SMART on FHIR
Access Scopes</a> for details) and the EHR supplied a <code>refresh_token</code> in the
authorization response.  To obtain a new access token, the app issues an HTTP
<code>POST</code> to the EHR authorization server&#39;s token URL, with content-type
<code>application/x-www-form-urlencoded</code></p>

<p>For <span class="label label-primary">public apps</span>, authentication is not
possible (and thus not required). For <span class="label
label-primary">confidential apps</span>, an <code>Authorization</code> header using HTTP
Basic authentication is required, where the username is the app&#39;s <code>client_id</code>
and the password is the app&#39;s <code>client_secret</code> (see
<a href="./basic-auth-example">example</a>).</p>

<p>The following request parameters are defined:</p>

<table class="table">
  <thead>
    <th colspan="3">Parameters</th>
  </thead>
  <tbody>

    <tr>
      <td><code>grant_type</code></td>
      <td><span class="label label-success">required</span></td>
      <td>Fixed value: <code>refresh_token</code>. </td>
    </tr>
    <tr>
      <td><code>refresh_token</code></td>
      <td><span class="label label-success">required</span></td>
      <td>The refresh token from a prior authorization response</td>
    </tr>
    <tr>
      <td><code>scope</code></td>
      <td><span class="label label-info">optional</span></td>
      <td>
The scopes of access requested. If present, this value must be a strict sub-set
of the scopes granted in the original launch (no new permissions can be
obtained at refresh time). A missing value indicates a request for the same
scopes granted in the original launch.
      </td>
    </tr>
  </tbody>
</table>

<p>The response is a JSON object containing a new access token, with the following claims:</p>

<table class="table">
  <thead>
    <th colspan="3">JSON Object property name</th>
  </thead>
  <tbody>
    <tr>
      <td><code>access_token</code></td>
      <td><span class="label label-success">required</span></td>
      <td>New access token issued by the authorization server.</td>
    </tr>
    <tr>
      <td><code>token_type</code></td>
      <td><span class="label label-success">required</span></td>
      <td>Fixed value: bearer</td>
    </tr>
    <tr>
      <td><code>expires_in</code></td>
      <td><span class="label label-success">required</span></td>
      <td>The lifetime in seconds of the access token. For example, the value 3600 denotes that the access token will expire in one hour from the time the response was generated.</td>
    </tr>
    <tr>
      <td><code>scope</code></td>
      <td><span class="label label-success">required</span></td>
      <td>Scope of access authorized. Note that this will be the same as the scope of the original access token, and it can be different from the scopes requested by the app.</td>
    </tr>
    <tr>
      <td><code>refresh_token</code></td>
      <td><span class="label label-info">optional</span></td>
      <td>The refresh token issued by the authorization server. If present, the app should discard any previosu <code>refresh_token</code> associated with this launch, replacing it with this new value.</td>
    </tr>
  </tbody>
</table>

<p>In addition, if the app was launched from within a patient context, 
parameters to communicate the context values MAY BE included. For example, 
a parameter like <code>&quot;patient&quot;: &quot;123&quot;</code> would indicate the FHIR resource 
https://[fhir-base]/Patient/123. Other context parameters may also 
be available. For full details see <a href="http://docs.smarthealthit.org/authorization/scopes-and-launch-context/">SMART launch context parameters</a>. </p>

<h4><em>For example</em></h4>

<p>If the EHR supports refresh tokens, an app may be able to replace an expired
access token programatically, without user interaction:</p>

<h5>Request</h5>
<div class="highlight"><pre><code class="language-text" data-lang="text">POST /token HTTP/1.1
Host: ehr
Authorization: Basic bXktYXBwOm15LWFwcC1zZWNyZXQtMTIz
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&amp;
refresh_token=a47txjiipgxkvohibvsm
</code></pre></div>
<h5>Response</h5>
<div class="highlight"><pre><code class="language-text" data-lang="text">{
  &quot;access_token&quot;: &quot;m7rt6i7s9nuxkjvi8vsx&quot;,
  &quot;token_type&quot;: &quot;bearer&quot;,
  &quot;expires_in&quot;: 3600,
  &quot;scope&quot;: &quot;patient/Observation.read patient/Patient.read&quot;,
  &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;
}
</code></pre></div>
          </div>


          <div class="col-md-3 page-content" role="main">
            <div class="alert alert-info">
             The SMART on FHIR API is evolving in parallel with the <a class="alert-link"
               href="http://hl7.org/fhir/timelines.html">FHIR ballot releases</a>.
             If you spot problems,
             please <a class="alert-link"
               href="https://github.com/smart-on-fhir/smart-on-fhir.github.io/issues">file
               an issue</a>. 
             
             Or better yet, you can <a class="alert-link edit-in-github" 
               href="">edit
               this page</a>.

            </div> 
          </div>

        </div>
      </div>
    </div>
    <script>
      window.github_branch = "fhir-au";
    </script>
    <script src="/smart-on-fhir/assets/js/jquery-2.1.0.js"></script>
    <script src="/smart-on-fhir/assets/js/bootstrap3.min.js"></script>
    <script src="/smart-on-fhir/assets/js/site.js"></script>
    <footer class="text-center">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            Version: <a href="/smart-on-fhir/releases/">fhir-au</a> - <a href="http://smarthealthit.org">SMART Health IT 2015</a>
          </div>
        </div>
      </div>
    </footer>
    
  </body>
</html>
